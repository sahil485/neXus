name: Deploy Nexus Backend

on:
  pull_request:
    branches:
      - main
    # tags:
    #   - "backend@*"

jobs:
  deploy-prod:
    # if: contains(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    environment: Production
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      BEARER_TOKEN: ${{ secrets.BEARER_TOKEN }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from tag
        id: get_version
        run: |
          VERSION="0.0.1"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Create .env file
        run: |
          cd backend
          echo "DATABASE_URL=${{ env.DATABASE_URL }}" >> .env
          echo "DB_USER=${{ env.DB_USER }}" >> .env
          echo "DB_PASSWORD=${{ env.DB_PASSWORD }}" >> .env
          echo "DB_HOST=${{ env.DB_HOST }}" >> .env
          echo "DB_PORT=${{ env.DB_PORT }}" >> .env
          echo "DB_NAME=${{ env.DB_NAME }}" >> .env
          echo "BEARER_TOKEN=${{ env.BEARER_TOKEN }}" >> .env
          echo "NEXT_PUBLIC_SUPABASE_URL=${{ env.NEXT_PUBLIC_SUPABASE_URL }}" >> .env
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ env.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" >> .env
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ env.SUPABASE_SERVICE_ROLE_KEY }}" >> .env
          echo "GROK_API_KEY=${{ env.GROK_API_KEY }}" >> .env
          echo "GEMINI_API_KEY=${{ env.GEMINI_API_KEY }}" >> .env

      - name: Build Docker image
        run: |
          cd backend
          docker build -t nexus-backend:${{ steps.get_version.outputs.version }} .
          docker save nexus-backend:${{ steps.get_version.outputs.version }} -o ../nexus-backend-${{ steps.get_version.outputs.version }}.tar

      - name: Install CDK dependencies
        run: |
          cd backend/cdk
          npm install

      - name: Bootstrap CDK (if needed)
        run: |
          cd backend/cdk
          npx cdk bootstrap aws://${{ env.AWS_ACCOUNT_ID }}/us-east-1 || true
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
          ENVIRONMENT: prod
          DATABASE_URL: ${{ env.DATABASE_URL }}
          DB_USER: ${{ env.DB_USER }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          DB_HOST: ${{ env.DB_HOST }}
          DB_PORT: ${{ env.DB_PORT }}
          DB_NAME: ${{ env.DB_NAME }}
          BEARER_TOKEN: ${{ env.BEARER_TOKEN }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ env.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ env.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}
          GROK_API_KEY: ${{ env.GROK_API_KEY }}
          GEMINI_API_KEY: ${{ env.GEMINI_API_KEY }}

      - name: Deploy to prod
        run: |
          cd backend/cdk
          npx cdk deploy nexus-backend-prod --require-approval never --progress events
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
          ENVIRONMENT: prod
          DATABASE_URL: ${{ env.DATABASE_URL }}
          DB_USER: ${{ env.DB_USER }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          DB_HOST: ${{ env.DB_HOST }}
          DB_PORT: ${{ env.DB_PORT }}
          DB_NAME: ${{ env.DB_NAME }}
          BEARER_TOKEN: ${{ env.BEARER_TOKEN }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ env.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ env.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}
          GROK_API_KEY: ${{ env.GROK_API_KEY }}
          GEMINI_API_KEY: ${{ env.GEMINI_API_KEY }}

      - name: Deployment Summary
        run: |
          echo "### Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** 0.0.1" >> $GITHUB_STEP_SUMMARY
          echo "- **Git SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
